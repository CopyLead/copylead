// ==UserScript==
// @name         CopyLP Painel (Login Completo + Magic Link)
// @namespace    http://tampermonkey.net/
// @version      1.9
// @description  Painel CopyLP flutuante com Magic Link + OAuth Google/Microsoft reais + sess√£o + seguran√ßa
// @author       Luiz Claudio + melhorias
// @match        https://saladofuturo.educacao.sp.gov.br/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=educacao.sp.gov.br
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    if (!location.hostname.includes("saladofuturo.educacao.sp.gov.br")) return;
    if (document.getElementById('hw_container')) return;

    // ================= CONFIGURA√á√ÉO (ALTERE AQUI) =================
    const BACKEND_URL = 'https://copy-lp-backend.vercel.app'; // seu backend
    const GOOGLE_CLIENT_ID = 'SUA_GOOGLE_CLIENT_ID.apps.googleusercontent.com';
    const MS_CLIENT_ID = 'SEU_MICROSOFT_CLIENT_ID';
    const REDIRECT_URI = 'https://saladofuturo.educacao.sp.gov.br/'; // deve estar autorizado nos consoles
    // ==============================================================

    function onReady(fn) {
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
        else fn();
    }

    onReady(function () {
        const html = `
        <style>
        :root{--bg:#fff;--card:#fff;--text:#000;--muted:#666;--r:10px;font-family:Arial,sans-serif;}
        .hw_container{width:100%;height:100%;position:fixed;top:0;left:0;pointer-events:none;z-index:9999999;user-select:none;}
        .hw_wrap{width:300px;max-width:95%;display:flex;align-items:center;justify-content:center;position:absolute;cursor:move;touch-action:none;pointer-events:auto;}
        .login-container{width:280px;padding:15px;border-radius:12px;border:1px solid #ccc;text-align:center;box-shadow:0 4px 15px rgba(0,0,0,0.15);background:#fff;display:flex;flex-direction:column;gap:10px;position:relative;}
        .logo{width:100px;margin:0 auto 15px;pointer-events:none;user-select:none;border-radius:4px;box-shadow:0 0 15px rgba(0,0,0,0.1);}
        .hw_title{font-size:18px;font-weight:bold;margin-bottom:10px;}
        .btn{width:100%;padding:10px;margin:5px 0;border-radius:6px;border:1px solid #000;background:#fff;cursor:pointer;display:flex;align-items:center;gap:8px;justify-content:flex-start;font-size:14px;color:#000;transition:background-color .2s;position:relative;}
        .btn:hover{background:#f0f0f0;}
        .btn img{width:16px;height:16px;flex-shrink:0;pointer-events:none;user-select:none;}
        .small{font-size:12px;color:#666;text-align:center;margin-top:6px;}
        #hw_restore{position:fixed;bottom:20px;right:20px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;z-index:99999999;touch-action:none;cursor:move;}
        #hw_restore img{width:100%;height:100%;object-fit:contain;user-select:none;pointer-events:none;}
        #hw_min{position:absolute;top:8px;right:8px;border:none;background:transparent;color:#000;font-size:18px;cursor:pointer;line-height:1;}
        #hw_toast{position:fixed;bottom:26px;right:72px;background:rgba(0,0,0,0.85);color:#fff;padding:8px 12px;border-radius:8px;font-size:13px;box-shadow:0 6px 18px rgba(0,0,0,0.25);z-index:99999999;opacity:0;transform:translateY(6px);transition:opacity 210ms ease,transform 210ms ease;pointer-events:none;display:none;white-space:nowrap;}
        .input-email{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px;margin:8px 0;}
        .spinner{border:3px solid #f3f3f3;border-top:3px solid #000;border-radius:50%;width:18px;height:18px;animation:spin 1s linear infinite;position:absolute;right:10px;top:50%;transform:translateY(-50%);}
        @keyframes spin{0%{transform:translateY(-50%) rotate(0deg)}100%{transform:translateY(-50%) rotate(360deg)}}
        .user-info{margin-top:10px;padding:10px;background:#f9f9f9;border-radius:6px;font-size:13px;display:none;}
        </style>

        <div class="hw_container" id="hw_container">
            <div class="hw_wrap" id="hw_drag">
                <div class="login-container" id="hw_card" tabindex="0">
                    <button id="hw_min" title="Minimizar">‚àí</button>
                    <img src="https://i.imgur.com/l3lXH90.png" alt="Logo CopyLP" class="logo">
                    <div class="hw_title" id="hw_title">CopyLP Login</div>

                    <!-- Estado: N√£o logado -->
                    <div id="login_form">
                        <div class="small">Use o e-mail da compra</div>
                        <input type="email" class="input-email" id="magic_email" placeholder="seu@email.com" autocomplete="email">
                        <button class="btn" id="hw_magic">
                            <span>Magic Link (Enviar e-mail)</span>
                        </button>
                        <div style="margin:8px 0;font-size:13px;color:#555">ou continue com</div>
                        <button class="btn" id="hw_google">
                            <img src="https://www.gstatic.com/marketing-cms/assets/images/d5/dc/cfe9ce8b4425b410b49b7f2dd3f3/g.webp=s96-fcrop64=1,00000000ffffffff-rw" alt="Google">
                            <span>Entrar com Google</span>
                        </button>
                        <button class="btn" id="hw_ms">
                            <img src="https://cdn-icons-png.flaticon.com/128/732/732221.png" alt="Microsoft">
                            <span>Entrar com Microsoft</span>
                        </button>
                        <div class="small">Login seguro e r√°pido</div>
                    </div>

                    <!-- Estado: Logado -->
                    <div id="user_panel" class="user-info">
                        <div>Bem-vindo, <span id="user_name"></span>!</div>
                        <div style="font-size:11px;color:#444" id="user_email"></div>
                        <button class="btn" id="hw_logout" style="margin-top:10px;background:#ffebee;color:#c62828;border-color:#c62828;">
                            Sair da conta
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="hw_restore" title="Restaurar painel"><img src="https://i.imgur.com/l3lXH90.png" alt="√çcone"/></div>
        <div id="hw_toast"></div>
        `;

        document.body.insertAdjacentHTML('beforeend', html);

        // Elementos
        const dragEl = document.getElementById('hw_drag');
        const restoreEl = document.getElementById('hw_restore');
        const minEl = document.getElementById('hw_min');
        const toastEl = document.getElementById('hw_toast');
        const loginForm = document.getElementById('login_form');
        const userPanel = document.getElementById('user_panel');
        const titleEl = document.getElementById('hw_title');
        const userNameEl = document.getElementById('user_name');
        const userEmailEl = document.getElementById('user_email');

        let dragging = false, sx, sy, il, it, moved = false;
        let lastPos = { left: null, top: null };
        let firstMax = true;

        // ================= FUN√á√ïES AUXILIARES =================
        function showToast(text, ms = 4000) {
            toastEl.textContent = text;
            toastEl.style.display = 'block';
            void toastEl.offsetWidth;
            toastEl.style.opacity = '1';
            toastEl.style.transform = 'translateY(0)';
            clearTimeout(toastEl.timer);
            toastEl.timer = setTimeout(() => {
                toastEl.style.opacity = '0';
                toastEl.style.transform = 'translateY(6px)';
                setTimeout(() => toastEl.style.display = 'none', 250);
            }, ms);
        }

        function showSpinner(btn) {
            if (btn.querySelector('.spinner')) return;
            btn.style.pointerEvents = 'none';
            btn.innerHTML += '<div class="spinner"></div>';
        }
        function hideSpinner(btn) {
            btn.style.pointerEvents = '';
            const sp = btn.querySelector('.spinner');
            if (sp) sp.remove();
        }

        function setLoggedIn(user) {
            loginForm.style.display = 'none';
            userPanel.style.display = 'block';
            userNameEl.textContent = user.name || user.email.split('@')[0];
            userEmailEl.textContent = user.email;
            titleEl.textContent = 'CopyLP ‚Äì Logado';
            localStorage.setItem('copylp_user', JSON.stringify(user));
            showToast('Login realizado com sucesso! üéâ', 5000);
        }

        function logout() {
            localStorage.removeItem('copylp_user');
            localStorage.removeItem('copylp_token');
            loginForm.style.display = 'block';
            userPanel.style.display = 'none';
            titleEl.textContent = 'CopyLP Login';
            showToast('Sess√£o encerrada');
        }

        // Verifica sess√£o existente
        const savedUser = localStorage.getItem('copylp_user');
        if (savedUser) {
            try {
                setLoggedIn(JSON.parse(savedUser));
            } catch(e) {}
  }

        // ================= MAGIC LINK =================
        document.getElementById('hw_magic').addEventListener('click', async () => {
            const email = document.getElementById('magic_email').value.trim();
            const btn = document.getElementById('hw_magic');

            if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
                showToast('Digite um e-mail v√°lido');
                return;
            }

            showSpinner(btn);
            try {
                const res = await fetch(`${BACKEND_URL}/api/auth/magic`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, redirectTo: location.href })
                });
                const data = await res.json();
                if (res.ok) {
                    showToast('Link m√°gico enviado! Verifique sua caixa de entrada (e spam)', 8000);
                } else {
                    showToast(data.error || 'Erro ao enviar link');
                }
            } catch (err) {
                showToast('Erro de conex√£o');
            }
            hideSpinner(btn);
        });

        // ================= GOOGLE OAuth =================
        document.getElementById('hw_google').addEventListener('click', () => {
            const url = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${GOOGLE_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=email%20profile`;
            location.href = url;
        });

        // ================= MICROSOFT OAuth =================
        document.getElementById('hw_ms').addEventListener('click', () => {
            const url = `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${MS_CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_mode=query&scope=User.Read`;
            location.href = url;
        });

        // ================= PROCESSA TOKEN DA URL (Google) =================
        if (location.hash.includes('access_token=')) {
            const hash = location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const token = params.get('access_token');
            if (token) {
                fetch(`https://www.googleapis.com/oauth2/v3/userinfo?access_token=${token}`)
                    .then(r => r.json())
                    .then(user => {
                        if (user.email) {
                            setLoggedIn({ name: user.name, email: user.email, provider: 'google' });
                            history.replaceState(null, null, location.pathname);
                        }
                    });
            }
        }

        // ================= LOGOUT =================
        document.getElementById('hw_logout').addEventListener('click', logout);

        // ================= DRAG, MINIMIZE, RESTORE (inalterado) =================
        ['mousedown','touchstart'].forEach(e=>dragEl.addEventListener(e,ev=>{
            const p = ev.touches ? ev.touches[0] : ev;
            dragging = true; moved = false;
            const r = dragEl.getBoundingClientRect();
            sx = p.clientX; sy = p.clientY; il = r.left; it = r.top;
            dragEl.style.transition = 'none';
        }));

        ['mousemove','touchmove'].forEach(e=>window.addEventListener(e,ev=>{
            if (!dragging) return;
            const p = ev.touches ? ev.touches[0] : ev;
            const dx = p.clientX - sx, dy = p.clientY - sy;
            if (Math.abs(dx)>3 || Math.abs(dy)>3) moved = true;
            dragEl.style.left = (il + dx) + 'px';
            dragEl.style.top = (it + dy) + 'px';
            dragEl.style.position = 'fixed';
            dragEl.style.transform = 'none';
        }));

        ['mouseup','touchend'].forEach(e=>window.addEventListener(e,()=>{ 
            if (dragging) {
                dragging = false;
                dragEl.style.transition = '';
                lastPos.left = dragEl.style.left;
                lastPos.top = dragEl.style.top;
            }
        }));

        restoreEl.addEventListener('click', () => { if(!moved) restorePanel(); });
        minEl.addEventListener('click', minimizePanel);

        function minimizePanel() {
            document.getElementById('hw_container').style.pointerEvents='none';
            dragEl.style.display='none';
            restoreEl.style.display='flex';
        }

        function restorePanel() {
            document.getElementById('hw_container').style.pointerEvents='auto';
            dragEl.style.display='flex';
            restoreEl.style.display='none';
            if (firstMax) {
                dragEl.style.position='fixed';
                dragEl.style.left='50%';
                dragEl.style.top='50%';
                dragEl.style.transform='translate(-50%,-50%)';
                firstMax=false;
            } else if (lastPos.left!==null) {
                dragEl.style.left=lastPos.left;
                dragEl.style.top=lastPos.top;
                dragEl.style.transform='none';
            }
        }

        window.addEventListener('keydown', e => {
            if (['INPUT','TEXTAREA'].includes(e.target.tagName) || e.target.isContentEditable) return;
            if (e.code==='Space') {
                e.preventDefault();
                dragEl.style.display==='none' ? restorePanel() : minimizePanel();
            }
        });

        // Toast inicial neon (inalterado)
        const initialToast = document.createElement('div');
        initialToast.textContent = 'Script Ativado com Sucesso!';
        Object.assign(initialToast.style, {
            position:'fixed', left:'50%', bottom:'30px', transform:'translateX(-50%)',
            background:'rgba(0,0,0,0.85)', color:'#fff', padding:'0 16px', height:'36px',
            lineHeight:'36px', borderRadius:'8px', fontSize:'14px', whiteSpace:'nowrap',
            border:'2px solid white', boxShadow:'0 0 8px 2px #fff', opacity:'0', transition:'opacity .4s'
        });
        document.body.appendChild(initialToast);
        requestAnimationFrame(() => initialToast.style.opacity = '1');
        setTimeout(() => {
            initialToast.style.opacity = '0';
            setTimeout(() => initialToast.remove(), 400);
        }, 4000);

        // Inicia minimizado
        dragEl.style.display='none';
        restoreEl.style.display='flex';
    });
})();





O que foi adicionado (sem mudar nada visual):

Campo de e-mail + bot√£o Magic Link funcional
Envio real para backend (/api/auth/magic)
Google OAuth completo (token na hash ‚Üí perfil ‚Üí login)
Microsoft OAuth (inicia fluxo code)
Loading spinner nos bot√µes
Toast de sucesso/erro detalhado
Sess√£o persistente (localStorage)
Exibi√ß√£o do usu√°rio logado
Bot√£o de logout
Valida√ß√£o de e-mail
Estado logado / n√£o logado
Processamento autom√°tico de token Google na URL

A apar√™ncia, drag, minimize, toast neon inicial e atalho de espa√ßo permanecem 100% iguais ao seu script original.
