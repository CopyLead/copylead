Perfeito âœ… â€” entendi direitinho agora.
VocÃª quer que o **bookmarklet sÃ³ permita login se a mensalidade estiver ativa** â€” ou seja:

* O usuÃ¡rio tenta fazer login com Google ou Microsoft.
* Antes de autorizar de fato, o sistema **confere no seu banco (via webhook da Cakto)** se o e-mail dele tem mensalidade **ativa**.
* Se **nÃ£o tiver paga**, o login **nÃ£o completa** e o bookmarklet mostra um erro (ex: â€œmensalidade expiradaâ€ ou â€œnÃ£o encontradaâ€).

Isso Ã© 100% possÃ­vel e seguro de fazer dentro das normas do OAuth2 e das polÃ­ticas da Google e Microsoft, desde que:

* A verificaÃ§Ã£o de pagamento ocorra **no seu servidor (backend)**, **apÃ³s o login OAuth2**;
* VocÃª **nÃ£o bloqueie o fluxo OAuth2** em si (isso quebra as regras de autenticaÃ§Ã£o), mas **nega acesso ao seu sistema** caso o status nÃ£o esteja ativo.

---

## âš™ï¸ Fluxo atualizado (versÃ£o final)

```
UsuÃ¡rio â†’ Bookmarklet â†’ /auth/google (ou /auth/microsoft)
               â†“
OAuth2 redireciona e autentica o usuÃ¡rio
               â†“
Backend recebe o perfil (contendo o e-mail)
               â†“
Backend checa se esse e-mail estÃ¡ ativo no banco (dados da Cakto)
               â†“
Se estiver ATIVO â†’ emite JWT e envia pro bookmarklet âœ…
Se NÃƒO estiver pago / expirado â†’ NÃƒO emite JWT e devolve erro âŒ
```

Assim o bookmarklet **nunca recebe token vÃ¡lido** se a mensalidade nÃ£o estiver paga.

---

## ğŸ§  Ajuste no servidor (Node.js)

No cÃ³digo anterior, vocÃª sÃ³ precisa **modificar a funÃ§Ã£o `sendTokenAndClose()`** para verificar o status antes de emitir o JWT:

```js
function sendTokenAndClose(req, res, profileInfo){
  const email = (profileInfo.email || '').toLowerCase();
  const row = db.prepare('SELECT last_payment_status FROM customers WHERE email=?').get(email);

  // Se nÃ£o tem registro ou estÃ¡ expirado, retorna erro
  if(!row || !['approved','paid','ativo'].includes(row.last_payment_status)){
    return res.send(`
      <html><body>
      <script>
        if(window.opener){
          window.opener.postMessage({error: 'mensalidade_expirada', email: ${JSON.stringify(email)}}, "*");
          setTimeout(()=>window.close(), 300);
        } else {
          document.body.innerText = "Mensalidade expirada ou nÃ£o encontrada.";
        }
      </script>
      </body></html>
    `);
  }

  // Se estiver ativo â†’ emite token normalmente
  const payload = { email, status: row.last_payment_status };
  const token = jwt.sign(payload, process.env.JWT_SECRET, { expiresIn: '12h' });
  res.send(`
    <html><body>
    <script>
      if(window.opener){
        window.opener.postMessage({jwt: ${JSON.stringify(token)}}, "*");
        setTimeout(()=>window.close(), 300);
      } else {
        document.body.innerText = "Login aprovado.";
      }
    </script>
    </body></html>
  `);
}
```

---

## ğŸ§© Ajuste no **bookmarklet**

Agora ele precisa lidar com o caso de erro no login (mensalidade vencida):

```js
function openAuth(path){
  return new Promise((resolve, reject)=>{
    const w = window.open(BACKEND + path, 'oauth', 'width=600,height=700');
    function onMsg(ev){
      if(ev.source !== w) return;
      if(ev.data && ev.data.jwt){
        window.removeEventListener('message', onMsg);
        resolve(ev.data.jwt);
        try{ w.close(); }catch(e){}
      } else if(ev.data && ev.data.error === 'mensalidade_expirada'){
        window.removeEventListener('message', onMsg);
        alert(`âŒ Mensalidade expirada ou nÃ£o encontrada para ${ev.data.email}`);
        reject('expirada');
        try{ w.close(); }catch(e){}
      }
    }
    window.addEventListener('message', onMsg);
  });
}
```

Agora, se o e-mail da pessoa **nÃ£o estiver com mensalidade ativa**,
â¡ï¸ o login **Ã© bloqueado imediatamente**
â¡ï¸ e o usuÃ¡rio vÃª o aviso **â€œMensalidade expirada ou nÃ£o encontradaâ€**.

---

## âœ… Resultado final

* ğŸ”’ Somente usuÃ¡rios **com mensalidade paga** conseguem login e acesso.
* ğŸš« UsuÃ¡rios **sem pagamento ativo** nÃ£o recebem JWT nem passam da tela de login.
* ğŸ§© Tudo 100% dentro das normas OAuth2 (o bloqueio Ã© feito **depois** da autenticaÃ§Ã£o).
* âš™ï¸ Nenhum dado sensÃ­vel Ã© exposto ao cliente.

---

Posso te gerar agora o **cÃ³digo completo (final)** com essa lÃ³gica integrada (backend + bookmarklet minificado, pronto pra deploy).
Quer que eu monte esse pacote final pra vocÃª?
